<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Finance Tracker - Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f4f4f9; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-google { background: #db4437; color: white; padding: 10px; text-decoration: none; border-radius: 4px; display: block; text-align: center; margin-top: 10px;}
        .card { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; }
        .income { color: green; } .expense { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ Finance Tracker</h1>
        <div id="auth">
            <input type="email" id="email" placeholder="Email"><input type="password" id="pass" placeholder="Password">
            <button onclick="login()">Login</button>
            <a href="/auth/google" class="btn-google">üåê Sign in with Google</a>
        </div>
        <div id="app" style="display:none;">
            <div style="background:#eee; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                <select id="globalCurrency" onchange="loadData()" style="width:auto;"><option value="USD">USD ($)</option><option value="INR">INR (‚Çπ)</option></select>
                <button onclick="location.reload()" style="width:auto;">Logout</button>
            </div>
            <h2 id="stats">Loading...</h2>
            <canvas id="financeChart"></canvas>
            <hr>
            <h3>Add Transaction</h3>
            <input type="text" id="desc" placeholder="Description">
            <input type="number" id="amt" placeholder="Amount">
            <select id="currency"><option value="USD">USD</option><option value="INR">INR</option></select>
            <select id="type"><option value="EXPENSE">Expense</option><option value="INCOME">Income</option></select>
            <input type="text" id="cat" placeholder="Category (e.g. Food)">
            <input type="file" id="receipt">
            <button onclick="addTxn()">Add</button>
            <h3>Set Budget</h3>
            <input type="text" id="bCat" placeholder="Category"><input type="number" id="bLim" placeholder="Limit in USD">
            <button onclick="setBudget()">Set Budget</button>
            <div id="budget-progress"></div>
            <div id="txns"></div>
        </div>
    </div>
    <script>
        const API_URL = ''; // Relative path for production
        let userId = null; let myChart = null;

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('userId')) { userId = params.get('userId'); document.getElementById('auth').style.display='none'; document.getElementById('app').style.display='block'; loadData(); }
        };

        async function login() {
            const res = await fetch('/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({email: document.getElementById('email').value, password: document.getElementById('pass').value})});
            const data = await res.json();
            if(res.ok) { userId = data.id; document.getElementById('auth').style.display='none'; document.getElementById('app').style.display='block'; loadData(); }
        }

        async function loadData() {
            const curr = document.getElementById('globalCurrency').value;
            const resStats = await fetch(`/dashboard/${userId}?currency=${curr}`);
            const stats = await resStats.json();
            document.getElementById('stats').innerText = `In: ${stats.income.toFixed(2)} | Out: ${stats.expense.toFixed(2)}`;
            
            const ctx = document.getElementById('financeChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'bar', data: { labels: ['Income', 'Expense'], datasets: [{ data: [stats.income, stats.expense], backgroundColor: ['green', 'red'] }] } });

            const resTx = await fetch(`/transactions/${userId}`);
            const txs = await resTx.json();
            document.getElementById('txns').innerHTML = txs.map(t => `<div class="card"><span>${t.description} (${t.currency})</span><span class="${t.type.toLowerCase()}">${t.amount}</span></div>`).join('');
            
            const resB = await fetch(`/budgets/${userId}/progress?currency=${curr}`);
            const budgets = await resB.json();
            document.getElementById('budget-progress').innerHTML = budgets.map(b => `<div>${b.category}: ${b.spent.toFixed(2)} / ${b.limit.toFixed(2)}</div>`).join('');
        }

        async function addTxn() {
            const fd = new FormData();
            fd.append('userId', userId); fd.append('description', document.getElementById('desc').value);
            fd.append('amount', document.getElementById('amt').value); fd.append('currency', document.getElementById('currency').value);
            fd.append('type', document.getElementById('type').value); fd.append('category', document.getElementById('cat').value);
            if(document.getElementById('receipt').files[0]) fd.append('receipt', document.getElementById('receipt').files[0]);
            await fetch('/transactions', { method: 'POST', body: fd });
            loadData();
        }

        async function setBudget() {
            await fetch('/budgets', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId, category: document.getElementById('bCat').value, limit: document.getElementById('bLim').value})});
            loadData();
        }
    </script>
</body>
</html>